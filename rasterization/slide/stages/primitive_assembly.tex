\section{Primitive Assembly}

\subsection{Overview}
\begin{frame}{Primitive Assembly Stage}
  \begin{columns}
    \begin{column}{0.6\textwidth}
      \begin{raybox}{Primitive Assembly}
        \textbf{Input:} Individual vertices from vertex/geometry shaders \\
        \textbf{Output:} Complete primitives (triangles, lines, points)

        \vspace{0.3cm}
        \textbf{Purpose:}
        \begin{itemize}
          \item Group vertices into geometric primitives
          \item Determine primitive topology
          \item Establish winding order
          \item Prepare for clipping and culling
          \end{itemize>

            \vspace{0.2cm}
            \textcolor{LightGray}{\textbf{Fixed-function stage}}
          \end{raybox}
        \end{column}
        \begin{column>{0.4\textwidth}
            \begin{tikzpicture}[scale=0.7]
              % Individual vertices
              \node at (0,3.5) {\textbf{Individual Vertices}};
              \fill[PrimaryColor] (0,3) circle (3pt);
              \fill[SecondaryColor] (0.8,2.8) circle (3pt);
              \fill[AccentColor] (0.4,2.2) circle (3pt);
              \fill[ObjectColor] (1.2,2) circle (3pt);
              \fill[PrimaryColor] (1.6,2.8) circle (3pt);
              \fill[SecondaryColor] (2,2.2) circle (3pt);

              \draw[->, thick, LightGray] (1,1.8) -- (1,1.2);
              \node[right] at (1.2,1.5) {\scriptsize Assembly};

              % Assembled triangles
              \node at (0,0.8) {\textbf{Triangles}};
              \draw[thick, PrimaryColor] (0,0.4) -- (0.8,0.2) -- (0.4,-0.4) -- cycle;
              \draw[thick, SecondaryColor] (1.2,-0.2) -- (2,0) -- (1.6,-0.6) -- cycle;
            \end{tikzpicture>
            \end{column>
            \end{columns>
            \end{frame>

              \subsection{Primitive Types}
              \begin{frame}{Primitive Assembly Types}
                \begin{columns}
                  \begin{column>{0.6\textwidth}
                      \begin{conceptbox>{Triangle Primitives}
                          \textbf{Triangle List:} Every 3 vertices form a triangle
                          \begin{itemize}
                            \item Vertices: 0,1,2 → Triangle 1
                            \item Vertices: 3,4,5 → Triangle 2
                            \item Most memory intensive but flexible
                            \end{itemize>

                              \vspace{0.2cm}
                              \textbf{Triangle Strip:} Shared vertices between triangles
                              \begin{itemize}
                                \item Vertices: 0,1,2 → Triangle 1
                                \item Vertices: 1,2,3 → Triangle 2
                                \item Memory efficient for connected surfaces
                                \end{itemize>

                                  \vspace{0.2cm}
                                  \textbf{Triangle Fan:} All triangles share first vertex
                                  \begin{itemize}
                                    \item Good for convex polygons
                                    \item Rarely used in modern graphics
                                    \end{itemize>
                                    \end{conceptbox>
                                    \end{column>
                                      \begin{column>{0.4\textwidth}
                                          \begin{tikzpicture}[scale=0.6]
                                            % Triangle List
                                            \node at (0,4.5) {\textbf{Triangle List}};
                                            \draw[thick, PrimaryColor] (0,4) -- (0.8,4) -- (0.4,3.4) -- cycle;
                                            \draw[thick, SecondaryColor] (1.5,4) -- (2.3,4) -- (1.9,3.4) -- cycle;
                                            \node[below] at (1.15,3.2) {\scriptsize 6 vertices};

                                            % Triangle Strip
                                            \node at (0,2.8) {\textbf{Triangle Strip}};
                                            \draw[thick, PrimaryColor] (0,2.3) -- (0.8,2.3) -- (0.4,1.7) -- cycle;
                                            \draw[thick, SecondaryColor] (0.8,2.3) -- (1.6,2.3) -- (1.2,1.7) -- cycle;
                                            \node[below] at (0.8,1.5) {\scriptsize 4 vertices};

                                            % Triangle Fan
                                            \node at (0,1.2) {\textbf{Triangle Fan}};
                                            \coordinate (center) at (0.8,0.5);
                                            \draw[thick, PrimaryColor] (center) -- (0.3,0.8) -- (0.3,0.2) -- cycle;
                                            \draw[thick, SecondaryColor] (center) -- (0.3,0.2) -- (1.3,0.2) -- cycle;
                                            \draw[thick, AccentColor] (center) -- (1.3,0.2) -- (1.3,0.8) -- cycle;
                                            \node[below] at (0.8,-0.1) {\scriptsize 5 vertices};
                                          \end{tikzpicture>
                                          \end{column>
                                          \end{columns>
                                          \end{frame>

                                            \subsection{Winding Order}
                                            \begin{frame>{Winding Order \& Face Orientation}
                                                \begin{columns}
                                                  \begin{column>{0.5\textwidth}
                                                      \begin{mathbox>{Winding Order}
                                                          \textbf{Determines which side of triangle is "front"}

                                                          \vspace{0.3cm}
                                                          \textbf{Counter-Clockwise (CCW):}
                                                          \begin{itemize}
                                                            \item OpenGL default
                                                            \item Front-facing when viewed from front
                                                            \item Vertices ordered: A → B → C
                                                            \end{itemize>

                                                              \vspace{0.2cm}
                                                              \textbf{Clockwise (CW):}
                                                              \begin{itemize}
                                                                \item DirectX default
                                                                \item Front-facing when viewed from front
                                                                \item Vertices ordered: A → C → B
                                                                \end{itemize>
                                                                \end{mathbox>
                                                                \end{column>
                                                                  \begin{column>{0.5\textwidth}
                                                                      \begin{tikzpicture}[scale=0.8]
                                                                        % CCW triangle
                                                                        \node at (0,3) {\textbf{Counter-Clockwise}};
                                                                        \coordinate (A1) at (0,2.5);
                                                                        \coordinate (B1) at (1.5,2.5);
                                                                        \coordinate (C1) at (0.75,1.5);

                                                                        \draw[thick, PrimaryColor] (A1) -- (B1) -- (C1) -- cycle;
                                                                        \fill[PrimaryColor] (A1) circle (2pt);
                                                                        \fill[PrimaryColor] (B1) circle (2pt);
                                                                        \fill[PrimaryColor] (C1) circle (2pt);

                                                                        % Arrow showing direction
                                                                        \draw[->, thick, SecondaryColor] (A1) arc (180:60:0.3);

                                                                        \node[left] at (A1) {\scriptsize A};
                                                                        \node[right] at (B1) {\scriptsize B};
                                                                        \node[below] at (C1) {\scriptsize C};
                                                                        \node[below] at (0.75,1.2) {\scriptsize Front Face};

                                                                        % CW triangle
                                                                        \node at (0,0.7) {\textbf{Clockwise}};
                                                                        \coordinate (A2) at (0,0.2);
                                                                        \coordinate (B2) at (1.5,0.2);
                                                                        \coordinate (C2) at (0.75,-0.8);

                                                                        \draw[thick, ObjectColor] (A2) -- (C2) -- (B2) -- cycle;
                                                                        \fill[ObjectColor] (A2) circle (2pt);
                                                                        \fill[ObjectColor] (B2) circle (2pt);
                                                                        \fill[ObjectColor] (C2) circle (2pt);

                                                                        % Arrow showing direction
                                                                        \draw[->, thick, AccentColor] (A2) arc (180:300:0.3);

                                                                        \node[left] at (A2) {\scriptsize A};
                                                                        \node[right] at (B2) {\scriptsize B};
                                                                        \node[below] at (C2) {\scriptsize C};
                                                                        \node[below] at (0.75,-1.1) {\scriptsize Front Face};
                                                                      \end{tikzpicture>
                                                                      \end{column>
                                                                      \end{columns>
                                                                      \end{frame>

                                                                        \begin{frame>{Back-Face vs Front-Face}
                                                                            \begin{columns}
                                                                              \begin{column>{0.6\textwidth}
                                                                                  \begin{raybox>{Face Determination}
                                                                                      \textbf{Process:}
                                                                                      \begin{enumerate}
                                                                                        \item Calculate triangle normal using cross product
                                                                                        \item Determine viewing direction
                                                                                        \item Compare normal and view direction
                                                                                        \item Classify as front-face or back-face
                                                                                        \end{enumerate>

                                                                                          \vspace{0.3cm}
                                                                                          \textbf{Mathematical test:}
                                                                                          \begin{align}
                                                                                            \mathbf{n} &= (\mathbf{v_1} - \mathbf{v_0}) \times (\mathbf{v_2} - \mathbf{v_0}) \\
                                                                                            \text{facing} &= \mathbf{n} \cdot \mathbf{view\_dir}
                                                                                          \end{align>

                                                                                            If $\text{facing} > 0$ → Front-face \\
                                                                                            If $\text{facing} < 0$ → Back-face
                                                                                          \end{raybox>
                                                                                          \end{column>
                                                                                            \begin{column>{0.4\textwidth}
                                                                                                \begin{tikzpicture}[scale=0.7]
                                                                                                  % Camera/viewer
                                                                                                  \node[circle, fill=PrimaryColor!30, minimum size=0.6cm] (cam) at (0,3) {\tiny \faIcon{eye}};

                                                                                                  % Front-facing triangle
                                                                                                  \coordinate (A) at (2,2.5);
                                                                                                  \coordinate (B) at (3.5,2.5);
                                                                                                  \coordinate (C) at (2.75,1.5);

                                                                                                  \draw[thick, SecondaryColor, fill=SecondaryColor!20] (A) -- (B) -- (C) -- cycle;

                                                                                                  % Normal vector (pointing toward camera)
                                                                                                  \coordinate (center) at (2.75,2.17);
                                                                                                  \draw[->, thick, SecondaryColor] (center) -- ++(180:0.8);
                                                                                                  \node[left] at (1.8,2.17) {\scriptsize $\mathbf{n}$};

                                                                                                  \node[below] at (2.75,1.2) {\scriptsize Front-face};
                                                                                                  \node[below] at (2.75,0.9) {\scriptsize (visible)};

                                                                                                  % Back-facing triangle
                                                                                                  \coordinate (D) at (2,0);
                                                                                                  \coordinate (E) at (3.5,0);
                                                                                                  \coordinate (F) at (2.75,-1);

                                                                                                  \draw[thick, DarkGray, fill=DarkGray!20] (D) -- (F) -- (E) -- cycle;

                                                                                                  % Normal vector (pointing away from camera)
                                                                                                  \coordinate (center2) at (2.75,-0.33);
                                                                                                  \draw[->, thick, DarkGray] (center2) -- ++(0:0.8);
                                                                                                  \node[right] at (3.6,-0.33) {\scriptsize $\mathbf{n}$};

                                                                                                  \node[below] at (2.75,-1.3) {\scriptsize Back-face};
                                                                                                  \node[below] at (2.75,-1.6) {\scriptsize (hidden)};

                                                                                                  % View direction
                                                                                                  \draw[dashed, PrimaryColor] (cam) -- (center);
                                                                                                  \draw[dashed, PrimaryColor] (cam) -- (center2);
                                                                                                \end{tikzpicture>
                                                                                                \end{column>
                                                                                                \end{columns>
                                                                                                \end{frame>

                                                                                                  \begin{frame>[fragile]{OpenGL Primitive Assembly Configuration}
                                                                                                      \begin{columns}
                                                                                                        \begin{column>{0.5\textwidth}
      \begin{minted}[fontsize=\tiny, bgcolor=LightGray!20]{c}
// Set primitive topology
// Triangle list (default)
glDrawArrays(GL_TRIANGLES, 0, vertexCount);
glDrawElements(GL_TRIANGLES, indexCount, GL_UNSIGNED_INT, indices);

// Triangle strip
glDrawArrays(GL_TRIANGLE_STRIP, 0, vertexCount);

// Triangle fan
glDrawArrays(GL_TRIANGLE_FAN, 0, vertexCount);

// Lines
glDrawArrays(GL_LINES, 0, vertexCount);
glDrawArrays(GL_LINE_STRIP, 0, vertexCount);

// Points
glDrawArrays(GL_POINTS, 0, vertexCount);

// Configure face orientation
glFrontFace(GL_CCW);  // Counter-clockwise (default)
glFrontFace(GL_CW);   // Clockwise
      \end{minted>
    \end{column>
    \begin{column>{0.5\textwidth}
      \begin{minted}[fontsize=\tiny, bgcolor=LightGray!20]{c}
// Example: Drawing a quad using triangle strip
float vertices[] = {
    // Position (x, y, z)    // UV (u, v)
    -0.5f, -0.5f, 0.0f,     0.0f, 0.0f,  // Bottom-left
     0.5f, -0.5f, 0.0f,     1.0f, 0.0f,  // Bottom-right
    -0.5f,  0.5f, 0.0f,     0.0f, 1.0f,  // Top-left
     0.5f,  0.5f, 0.0f,     1.0f, 1.0f   // Top-right
};

// Triangle strip forms 2 triangles:
// Triangle 1: vertices[0], vertices[1], vertices[2]
// Triangle 2: vertices[1], vertices[3], vertices[2]

glBindVertexArray(VAO);
glDrawArrays(GL_TRIANGLE_STRIP, 0, 4);

// Ensure counter-clockwise winding
glFrontFace(GL_CCW);
      \end{minted>
    \end{column>
  \end{columns>
\end{frame>

\begin{frame>{Primitive Assembly Considerations}
  \begin{columns}
    \begin{column>{0.5\textwidth}
      \begin{conceptbox>{Performance Implications}
        \textbf{Triangle strips vs triangle lists:}
        \begin{itemize}
          \item \textbf{Memory:} Strips use fewer vertices
          \item \textbf{Cache:} Better vertex cache utilization
          \item \textbf{Flexibility:} Lists allow arbitrary topology
          \item \textbf{Modern GPUs:} Performance difference minimal
        \end{itemize>

        \vspace{0.2cm}
        \textbf{Indexed drawing benefits:}
        \begin{itemize}
          \item Reduces vertex duplication
          \item Lower memory bandwidth
          \item Better cache performance
        \end{itemize>
      \end{conceptbox>
    \end{column>
    \begin{column>{0.5\textwidth}
      \begin{mathbox>{Best Practices}
        \begin{itemize}
          \item \textbf{Use indexed drawing} for complex meshes
          \item \textbf{Consistent winding order} across all triangles
          \item \textbf{Triangle lists} are most common and flexible
          \item \textbf{Consider primitive restart} for strip connectivity
          \item \textbf{Group similar primitives} in draw calls
        \end{itemize>
      \end{mathbox>

      \vspace{0.3cm}

      \begin{raybox>{Common Issues}
        \begin{itemize>
          \item \textbf{Wrong winding order} → faces appear inside-out
          \item \textbf{Degenerate triangles} → zero-area triangles
          \item \textbf>Inconsistent topology} → rendering artifacts
        \end{itemize>
      \end{raybox>
    \end{column>
  \end{columns>
\end{frame>
